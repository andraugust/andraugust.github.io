<!DOCTYPE html>
<html lang="en">

  <head>

    <!-- Non social metatags -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="theme-color" content="#157878">

    

    <title>Winning at Dice with Backward Induction</title>

    
      <!-- Update your html tag to include the itemscope and itemtype attributes. -->
<html itemscope itemtype="http://schema.org/Article">












<!-- Place this data between the <head> tags of your website -->

<meta name="description" content="Winning at Dice with Backward Induction" />





<!-- Schema.org markup for Google+ -->
<meta itemprop="name" content="Winning at Dice with Backward Induction">
<meta itemprop="description" content="Winning at Dice with Backward Induction">

  <meta itemprop="image" content="http://localhost:4000">


<!-- Twitter Card data -->
<meta name="twitter:card" content="summary_large_image">



<meta name="twitter:title" content="Winning at Dice with Backward Induction">
<meta name="twitter:description" content="Winning at Dice with Backward Induction">



<!-- Twitter summary card with large image must be at least 280x150px -->

  <meta name="twitter:image:src" content="http://localhost:4000">
  <meta property="twitter:image" content="http://localhost:4000">

<meta property="twitter:url" content="http://localhost:4000/bellman/">

<!-- Open Graph data -->
<meta property="og:title" content="Winning at Dice with Backward Induction" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:4000/bellman/" />

  <meta property="og:image" content="http://localhost:4000" />

<meta property="og:description" content="Winning at Dice with Backward Induction" />
<meta property="og:site_name" content="Andrew August's Notebook" />

  <meta property="article:published_time" content="2017-11-04T00:00:00-07:00" />












  





  




    

    <link rel="canonical" href="http://localhost:4000/bellman/">

    

    <link rel="shortcut icon" href="http://localhost:4000/favicon.ico">
    <meta name="robots" content="noarchive">

    <!-- <link rel="alternate" media="only screen and (max-width: 640px)" href="">
    <link rel="alternate" media="handheld" href=""> -->


    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="/assets/css/style.css?v=">
  </head>
  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">
    
    

    
      <a class="site-title" href="/">Andrew August&#39;s Notebook</a>
    

    
      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
          
            
            
          
            
            
              
                <a class="page-link" href="/about/">About</a>
              
            
          
        </div>
      </nav>
    
  </div>
</header>


    
    
    

    <section class="page-header">
      <h1 class="project-name">Winning at Dice with Backward Induction</h1>
      <h2 class="project-tagline"></h2>
      
      <!-- Post tagline -->
      
      <!-- End: Post tagline -->
    </section>

    <section class="main-content">

      <p><br /></p>
<h2><center>Winning at Dice with Backward Induction</center></h2>

<p><img src="dice.JPG" alt="bellman/dice.JPG" /></p>
<center><p>All threes&mdash;the infamous <em>hallelujah</em> roll.</p></center>

<h3 id="backward-induction">Backward Induction</h3>

<p>Backward induction identifies optimal actions by working backward in time.  It starts at the last step of a problem, identifies the optimal action there, then uses that action to identify the optimal action at the second-to-last step, continuing until the current step.</p>

<p>It may seem like this requires us to simulate the problem backwards every time we want to make a decision (an expensive procedure) but we actually don’t have to:  there’s a nice cacheing technique that allows us to simulate only once.  We’ll walk through this cacheing technique, but first let’s look at the game we’re going to solve.</p>

<h3 id="threes-how-to-play">Threes: How to Play</h3>

<p>Threes is a two player game. The first player starts by rolling all five dice and collects whichever they want to keep.  After collecting they roll the remaining dice and collect again, continuing until they’ve collected all the dice.  When all the dice are collected the player’s score is counted as the sum of their dice where <strong>threes count as zero</strong>.  The second player rolls the same way and the player with the lowest score wins.</p>

<p>Dice are collected in an interesting way.  Players are supposed to collect at least one dice after each roll, but if they roll all high dice and don’t want to take any they can choose to collect no dice and re-roll but with the consequence of having to collect <strong>at least two</strong> on the re-roll.</p>

<p>As-per the rules, players can’t skip re-rolls and, e.g., take at least three dice on a re-re-roll, and players can’t re-roll the last die, they have to take it.  An example game is shown in the appendix at the end of this post.</p>

<h3 id="game-representation">Game Representation</h3>
<p>Here’s how we’ll represent Threes:</p>

<ul>
  <li>
    <p><strong>Game-states</strong> consist of a list of rolled dice values and a binary take-two indicator.  For example, the state <script type="math/tex">s = ((0,2,4,6),T)</script> indicates a roll of <script type="math/tex">(0,2,4,6)</script> where at least two dice have to be taken.  The value <script type="math/tex">3</script> is written as <script type="math/tex">0</script> and the other outcomes are written in sorted order.  The sorted order is useful because later we’re going to refer to dice using an index into the roll list and we want low indices to correspond to low dice values.</p>
  </li>
  <li>
    <p><strong>Actions</strong> are an integer <script type="math/tex">a</script> indicating the number of dice to take.  Since we’re trying to minimize score, we’ll assume that these are the <em>lowest</em> <script type="math/tex">a</script> dice.  Note that <script type="math/tex">0 \le a \le len(r)</script>, where <script type="math/tex">r</script> is the roll-list and <script type="math/tex">len</script> is its length/number of elements.</p>
  </li>
  <li>
    <p><strong>Game Dynamics</strong>: Game dynamics are determined by a pseudo-random number generator that gives each dice a uniformly random outcome.  Agent actions are determined by a policy <script type="math/tex">a(s)</script> that maps states to actions.  Note that an agent is fully specified by its policy and in this sense <em>is</em> its policy.</p>
  </li>
</ul>

<h3 id="rolling-first">Rolling First</h3>
<p>If you roll first, you don’t know what your opponent’s score is going to be, so your best bet is to minimize final score.</p>

<p>To find the policy that does this, we’ll make a probabilistic model of dice outcomes and use it to predict which actions will result in which scores, then we’ll choose an action that minimizes expected score and take this as our policy.</p>

<p>In technical slang we’re treating the game as a <em>Markov decision process</em> and we’re solving it using <em>backward induction</em> on the <em>Bellman equation</em>, but an easier way to understand what’s going on is to look at a few examples.</p>

<p>Suppose there are two dice left and we don’t have to take two and we roll <script type="math/tex">(1,6)</script>.  The diagram below shows the decisions we can make.</p>

<p><img src="decisions1.png" alt="bellman/decisions1.png" /></p>

<p>The quantity <script type="math/tex">v</script> indicates how many points we expect to collect on the <em>next</em> roll, assuming we select the corresponding action.  For example, <script type="math/tex">v(len(r)=2,\texttt{taketwo}=T) = 6</script> because rolling two dice and collecting them both gives a total of <script type="math/tex">6</script> on average.  The bottom of the tree contains numbers that are used to make our final decision.  In this case <script type="math/tex">a=1</script> is the optimal decision because cost plus value is minimum.</p>

<p>One more example, then we can generalize the solution:</p>

<p><img src="decisions2.png" alt="bellman/decisions2.png" /></p>

<p>In this case we can’t choose an action because we don’t know <script type="math/tex">v(len(r)=3, \texttt{taketwo}=T)</script> or <script type="math/tex">v(len(r)=2, \texttt{taketwo}=F)</script>, but we can approximate them using simulations.  For example, <script type="math/tex">len(r)=2, \texttt{taketwo}=F</script> is the situation shown in the first tree, and we were able to make a decision there, so we’ll simulate this situation several times and average the score of the optimal action there.  The result is <script type="math/tex">v(len(r)=3, \texttt{taketwo}=T)=7</script>.  Using a similar technique we find that <script type="math/tex">v(len(r)=2, \texttt{taketwo}=F)=4</script>.</p>

<p>Thus the optimal action is <script type="math/tex">a=1</script>. Notice that we had to simulate backward starting from the end of the game.  This is the defining property of backward induction.  To prevent redundant simulations, we cache values so we only have to simulate once per state, afterwards we can just look-up the information we no to act.</p>

<p><strong>The Value Function</strong>. Once we have all the values <script type="math/tex">v</script> it’s simple to choose the optimal action from an arbitrary state: choose the action that minimizes immediate points <em>plus</em> next-state value.  Notice that <script type="math/tex">v</script> depends on the <em>number</em> of dice being rolled and not on the dice values themselves.  This means that the game can be represented more simply in terms of the number of dice rolled <script type="math/tex">len(r)</script> and the take-two indicator.  The values are organized in a table called <em>the value function</em>.  Here it is:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center"><em>len(r)</em></th>
      <th style="text-align: center"><em>taketwo</em></th>
      <th style="text-align: center"><em>v</em></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">1</td>
      <td style="text-align: center">F</td>
      <td style="text-align: center">3</td>
    </tr>
    <tr>
      <td style="text-align: center">2</td>
      <td style="text-align: center">T</td>
      <td style="text-align: center">6</td>
    </tr>
    <tr>
      <td style="text-align: center">2</td>
      <td style="text-align: center">F</td>
      <td style="text-align: center">4</td>
    </tr>
    <tr>
      <td style="text-align: center">3</td>
      <td style="text-align: center">T</td>
      <td style="text-align: center">7</td>
    </tr>
    <tr>
      <td style="text-align: center">3</td>
      <td style="text-align: center">F</td>
      <td style="text-align: center">4.8</td>
    </tr>
    <tr>
      <td style="text-align: center">4</td>
      <td style="text-align: center">T</td>
      <td style="text-align: center">7</td>
    </tr>
    <tr>
      <td style="text-align: center">4</td>
      <td style="text-align: center">F</td>
      <td style="text-align: center">5.3</td>
    </tr>
    <tr>
      <td style="text-align: center">5</td>
      <td style="text-align: center">T</td>
      <td style="text-align: center">7</td>
    </tr>
    <tr>
      <td style="text-align: center">5</td>
      <td style="text-align: center">F</td>
      <td style="text-align: center">5.6</td>
    </tr>
  </tbody>
</table>

<p><strong>The Optimal Policy</strong>. The value function and the heuristic “choose the action which minimizes immediate points plus next-state value” defines the optimal policy.  Here’s the formula:</p>

<center> $$a(s) = \arg \min_{a'} \bigl (r[0:a'] + v(len(r)-a',a'==0) \bigr)$$ </center>
<p><script type="math/tex">r[0:a']</script> is the number of points gained from the immediate action, and <script type="math/tex">v(len(r)-a',a'==0)</script> is the value of the next state assuming action <script type="math/tex">a'</script> is taken.</p>

<p><strong>Experiments</strong>. Let’s do some experiments to see how well the optimal policy plays.  Here’s a comparison between the optimal policy and a policy that takes one lowest dice on every roll.  30,000 games were simulated:</p>

<center><img src="take-one.png" /></center>

<p>Here’s a comparison between the optimal policy and <em>my</em> policy.  To approximate my policy I played Threes three hundred times and recorded my score after each game (yes I actually did that).  On average the optimal policy gets a score of 5.6, while I get a score of 5.8.  Evidently I play approximately optimally–this is very re-assuring.</p>

<center><img src="human.png" /></center>

<h3 id="rolling-second">Rolling Second</h3>
<p>If we roll second we know what score to beat, so instead of acting to minimizing final score we’ll act to maximize probability of winning.  Again it’s helpful to start with an example.</p>

<p>Suppose we roll two dice, resulting in <script type="math/tex">(1,6)</script>, and the opponent’s score is <script type="math/tex">5</script> and our score-so-far is <script type="math/tex">3</script>, and we don’t have to take two.  We’ll parameterize the problem in terms of the <em>gap</em> <script type="math/tex">g</script> between our score and the opponent’s score. <strong>In order to win or tie we have to preserve <script type="math/tex">g \ge 0</script></strong>.  In this example <script type="math/tex">g=2</script>.  The decision tree below shows the actions we can take:</p>

<center><img src="roll-second.png" /></center>

<p>The values, i.e., the probabilities of winning, are computed by simulation.  For <script type="math/tex">a=0</script> we simulate collecting two dice, and for <script type="math/tex">a=1</script> we simulate taking one dice with an update to <script type="math/tex">g</script> to account for the dice we took.  The results are <script type="math/tex">v(len(r)=2,\texttt{taketwo}=T,g=2)=0.166</script> and <script type="math/tex">v(len(r)=1,\texttt{taketwo}=F,g=1)=0.333</script>.  Thus we choose <script type="math/tex">a=1</script>.  Note that we didn’t consider <script type="math/tex">a=2</script> because it makes <script type="math/tex">% <![CDATA[
g < 0 %]]></script>.</p>

<p><strong>The Value Function</strong>.  The value function is a little more complicated compared to when we were rolling first; it now depends on <script type="math/tex">g</script>, which can have up to 30 values.   Instead of listing all the values in a table, we’ll put them in a code snippet that also shows how to compute them.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># adjust these as needed</span>
<span class="n">taketwo</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">nleft</span> <span class="o">=</span> <span class="mi">5</span>    <span class="c"># referred to as "len(r)" in the post</span>

<span class="n">d</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">]</span> <span class="c"># possible dice values</span>

<span class="k">def</span> <span class="nf">get_pwin</span><span class="p">(</span><span class="n">nleft</span><span class="p">,</span><span class="n">taketwo</span><span class="p">,</span><span class="n">g</span><span class="p">):</span>
    <span class="c"># return the probability of winning for the given input state.  these are the values of the value function.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">nleft</span><span class="p">,</span> <span class="n">taketwo</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="mf">0.1667</span><span class="p">,</span> <span class="mf">0.3334</span><span class="p">,</span> <span class="mf">0.5001</span><span class="p">,</span> <span class="mf">0.5001</span><span class="p">,</span> <span class="mf">0.6668</span><span class="p">,</span> <span class="mf">0.8335</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">][</span><span class="n">g</span><span class="p">]</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">nleft</span><span class="p">,</span> <span class="n">taketwo</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="bp">True</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="mf">0.028</span><span class="p">,</span> <span class="mf">0.083</span><span class="p">,</span> <span class="mf">0.166</span><span class="p">,</span> <span class="mf">0.221</span><span class="p">,</span> <span class="mf">0.304</span><span class="p">,</span> <span class="mf">0.414</span><span class="p">,</span> <span class="mf">0.581</span><span class="p">,</span> <span class="mf">0.691</span><span class="p">,</span> <span class="mf">0.774</span><span class="p">,</span> <span class="mf">0.829</span><span class="p">,</span> <span class="mf">0.912</span><span class="p">,</span> <span class="mf">0.967</span><span class="p">,</span> <span class="mf">0.995</span><span class="p">][</span><span class="n">g</span><span class="p">]</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">nleft</span><span class="p">,</span> <span class="n">taketwo</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="mf">0.093</span><span class="p">,</span> <span class="mf">0.238</span><span class="p">,</span> <span class="mf">0.398</span><span class="p">,</span> <span class="mf">0.508</span><span class="p">,</span> <span class="mf">0.623</span><span class="p">,</span> <span class="mf">0.724</span><span class="p">,</span> <span class="mf">0.849</span><span class="p">,</span> <span class="mf">0.914</span><span class="p">,</span> <span class="mf">0.950</span><span class="p">,</span> <span class="mf">0.972</span><span class="p">,</span> <span class="mf">0.993</span><span class="p">,</span> <span class="mf">0.999</span><span class="p">,</span> <span class="mf">0.999</span><span class="p">][</span><span class="n">g</span><span class="p">]</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">nleft</span><span class="p">,</span> <span class="n">taketwo</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="bp">True</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="mf">0.0162</span><span class="p">,</span> <span class="mf">0.0582</span><span class="p">,</span> <span class="mf">0.1297</span><span class="p">,</span> <span class="mf">0.2077</span><span class="p">,</span> <span class="mf">0.2954</span><span class="p">,</span> <span class="mf">0.3857</span><span class="p">,</span> <span class="mf">0.4987</span><span class="p">,</span> <span class="mf">0.5955</span><span class="p">,</span> <span class="mf">0.6814</span><span class="p">,</span> <span class="mf">0.7531</span><span class="p">,</span> <span class="mf">0.8300</span><span class="p">,</span> <span class="mf">0.8882</span><span class="p">,</span> <span class="mf">0.9293</span><span class="p">,</span> <span class="mf">0.9550</span><span class="p">,</span> <span class="mf">0.9753</span><span class="p">,</span> <span class="mf">0.9884</span><span class="p">,</span> <span class="mf">0.9962</span><span class="p">,</span> <span class="mf">0.9993</span><span class="p">][</span><span class="n">g</span><span class="p">]</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">nleft</span><span class="p">,</span> <span class="n">taketwo</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="mf">0.0580</span><span class="p">,</span> <span class="mf">0.1634</span><span class="p">,</span> <span class="mf">0.3050</span><span class="p">,</span> <span class="mf">0.4322</span><span class="p">,</span> <span class="mf">0.5596</span><span class="p">,</span> <span class="mf">0.6698</span><span class="p">,</span> <span class="mf">0.7774</span><span class="p">,</span> <span class="mf">0.8611</span><span class="p">,</span> <span class="mf">0.9183</span><span class="p">,</span> <span class="mf">0.9492</span><span class="p">,</span> <span class="mf">0.9722</span><span class="p">,</span> <span class="mf">0.9857</span><span class="p">,</span> <span class="mf">0.9929</span><span class="p">,</span> <span class="mf">0.9964</span><span class="p">,</span> <span class="mf">0.9988</span><span class="p">,</span> <span class="mf">0.9997</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">][</span><span class="n">g</span><span class="p">]</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">nleft</span><span class="p">,</span> <span class="n">taketwo</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="bp">True</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="mf">0.0142</span><span class="p">,</span> <span class="mf">0.0528</span><span class="p">,</span> <span class="mf">0.1237</span><span class="p">,</span> <span class="mf">0.2125</span><span class="p">,</span> <span class="mf">0.3125</span><span class="p">,</span> <span class="mf">0.4161</span><span class="p">,</span> <span class="mf">0.5249</span><span class="p">,</span> <span class="mf">0.6290</span><span class="p">,</span> <span class="mf">0.7208</span><span class="p">,</span> <span class="mf">0.7944</span><span class="p">,</span> <span class="mf">0.8556</span><span class="p">,</span> <span class="mf">0.9016</span><span class="p">,</span> <span class="mf">0.9357</span><span class="p">,</span> <span class="mf">0.9587</span><span class="p">,</span> <span class="mf">0.9752</span><span class="p">,</span> <span class="mf">0.9859</span><span class="p">,</span> <span class="mf">0.9928</span><span class="p">,</span> <span class="mf">0.9964</span><span class="p">,</span> <span class="mf">0.9983</span><span class="p">,</span> <span class="mf">0.9993</span><span class="p">,</span> <span class="mf">0.9998</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">][</span><span class="n">g</span><span class="p">]</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">nleft</span><span class="p">,</span> <span class="n">taketwo</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="mf">0.0433</span><span class="p">,</span> <span class="mf">0.1258</span><span class="p">,</span> <span class="mf">0.2489</span><span class="p">,</span> <span class="mf">0.3750</span><span class="p">,</span> <span class="mf">0.4999</span><span class="p">,</span> <span class="mf">0.6184</span><span class="p">,</span> <span class="mf">0.7311</span><span class="p">,</span> <span class="mf">0.8227</span><span class="p">,</span> <span class="mf">0.8915</span><span class="p">,</span> <span class="mf">0.9358</span><span class="p">,</span> <span class="mf">0.9634</span><span class="p">,</span> <span class="mf">0.9801</span><span class="p">,</span> <span class="mf">0.9898</span><span class="p">,</span> <span class="mf">0.9948</span><span class="p">,</span> <span class="mf">0.9975</span><span class="p">,</span> <span class="mf">0.9988</span><span class="p">,</span> <span class="mf">0.9995</span><span class="p">,</span> <span class="mf">0.9998</span><span class="p">,</span> <span class="mf">0.9999</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">][</span><span class="n">g</span><span class="p">]</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">nleft</span><span class="p">,</span> <span class="n">taketwo</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="bp">True</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="mf">0.0130</span><span class="p">,</span> <span class="mf">0.0493</span><span class="p">,</span> <span class="mf">0.1162</span><span class="p">,</span> <span class="mf">0.2048</span><span class="p">,</span> <span class="mf">0.3101</span><span class="p">,</span> <span class="mf">0.4198</span><span class="p">,</span> <span class="mf">0.5318</span><span class="p">,</span> <span class="mf">0.6364</span><span class="p">,</span> <span class="mf">0.7305</span><span class="p">,</span> <span class="mf">0.8070</span><span class="p">,</span> <span class="mf">0.8659</span><span class="p">,</span> <span class="mf">0.9097</span><span class="p">,</span> <span class="mf">0.9418</span><span class="p">,</span> <span class="mf">0.9631</span><span class="p">,</span> <span class="mf">0.9775</span><span class="p">,</span> <span class="mf">0.9867</span><span class="p">,</span> <span class="mf">0.9926</span><span class="p">,</span> <span class="mf">0.9959</span><span class="p">,</span> <span class="mf">0.9978</span><span class="p">,</span> <span class="mf">0.9989</span><span class="p">,</span> <span class="mf">0.9995</span><span class="p">,</span> <span class="mf">0.9998</span><span class="p">,</span> <span class="mf">0.9999</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">][</span><span class="n">g</span><span class="p">]</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">nleft</span><span class="p">,</span> <span class="n">taketwo</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="mf">0.0356</span><span class="p">,</span> <span class="mf">0.1059</span><span class="p">,</span> <span class="mf">0.2144</span><span class="p">,</span> <span class="mf">0.3359</span><span class="p">,</span> <span class="mf">0.4604</span><span class="p">,</span> <span class="mf">0.5793</span><span class="p">,</span> <span class="mf">0.6940</span><span class="p">,</span> <span class="mf">0.7910</span><span class="p">,</span> <span class="mf">0.8659</span><span class="p">,</span> <span class="mf">0.9190</span><span class="p">,</span> <span class="mf">0.9535</span><span class="p">,</span> <span class="mf">0.9746</span><span class="p">,</span> <span class="mf">0.9868</span><span class="p">,</span> <span class="mf">0.9934</span><span class="p">,</span> <span class="mf">0.9968</span><span class="p">,</span> <span class="mf">0.9985</span><span class="p">,</span> <span class="mf">0.9993</span><span class="p">,</span> <span class="mf">0.9997</span><span class="p">,</span> <span class="mf">0.9999</span><span class="p">,</span> <span class="mf">0.9999</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">,</span> <span class="mf">1.0000</span><span class="p">][</span><span class="n">g</span><span class="p">]</span>

<span class="c"># approximate the win-probabilities by simulating all actions for all gaps.  this block is fairly dense...</span>
<span class="n">n_sims</span> <span class="o">=</span> <span class="mi">300000</span>
<span class="n">avgs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nleft</span><span class="o">*</span><span class="mi">6</span><span class="p">):</span>
    <span class="n">pmaxs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'gap = '</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">g</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_sims</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">nleft</span><span class="p">))</span>
        <span class="n">probs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nleft</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nleft</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">taketwo</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">gnew</span> <span class="o">=</span> <span class="n">g</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">a</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">gnew</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="n">nleft</span><span class="p">:</span>
                <span class="n">probs</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">probs</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_pwin</span><span class="p">(</span><span class="n">nleft</span><span class="o">-</span><span class="n">a</span><span class="p">,</span><span class="n">a</span><span class="o">==</span><span class="mi">0</span><span class="p">,</span><span class="n">gnew</span><span class="p">)</span>
        <span class="n">pmaxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="nb">max</span><span class="p">(</span><span class="n">probs</span><span class="p">))</span>
    <span class="n">avgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pmaxs</span><span class="p">))</span>

<span class="k">print</span><span class="p">(</span><span class="n">avgs</span><span class="p">)</span>   <span class="c"># the average probabilities of winning</span>
</code></pre></div></div>

<p><strong>The Optimal Policy</strong>.  The optimal policy for rolling second is:</p>

<center> $$a(s,g) = \arg \max_{a'} v(len(r)-a',a==0,g-r[0:a])$$ </center>

<p>Here <script type="math/tex">v</script> is the value/win-probability of the corresponding state-triple; values are listed in the code-snippet above.  To evaluate this equation it’s necessary to know the values for all actions being considered.</p>

<p>Initially values are only available for states at the end of the game, so it’s necessary to simulate backward from <script type="math/tex">len(r)=1</script> to <script type="math/tex">len(r)=5</script> and place win-probabilities in the value function as they’re discovered.  This is backward induction + value-cacheing.</p>

<p><strong>Experiments</strong>.  To conclude the study, I’ll roll first against the AI and see how often I win.  Here’s the result:</p>

<center><img src="airollsecond.png" /></center>

<p>Evidently the AI has an advantage, but it’s probably minimal enough to keep the game fun!</p>

<h3 id="appendix">Appendix</h3>

<p><strong>Example Game.</strong> Here’s an example game, the winner is Player 2 who used a re-roll on the second roll.</p>

<h4 id="player-1">Player 1</h4>

<table>
  <thead>
    <tr>
      <th style="text-align: center">Rolled</th>
      <th style="text-align: center">Collected</th>
      <th style="text-align: center">Cumulative Collected</th>
      <th style="text-align: center">Cumulative Score</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">4,3,5,3,1</td>
      <td style="text-align: center">3,3</td>
      <td style="text-align: center">3,3</td>
      <td style="text-align: center">0</td>
    </tr>
    <tr>
      <td style="text-align: center">4,3,1</td>
      <td style="text-align: center">3,1</td>
      <td style="text-align: center">3,3,3,1</td>
      <td style="text-align: center">1</td>
    </tr>
    <tr>
      <td style="text-align: center">6</td>
      <td style="text-align: center">6</td>
      <td style="text-align: center">3,3,3,1,6</td>
      <td style="text-align: center">7</td>
    </tr>
  </tbody>
</table>

<p><br /></p>

<h4 id="player-2">Player 2</h4>

<table>
  <thead>
    <tr>
      <th style="text-align: center">Rolled</th>
      <th style="text-align: center">Collected</th>
      <th style="text-align: center">Cumulative Collected</th>
      <th style="text-align: center">Cumulative Score</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">3,3,1,2,5</td>
      <td style="text-align: center">3,3</td>
      <td style="text-align: center">3,3</td>
      <td style="text-align: center">0</td>
    </tr>
    <tr>
      <td style="text-align: center">6,4,5</td>
      <td style="text-align: center">—</td>
      <td style="text-align: center">3,3</td>
      <td style="text-align: center">0</td>
    </tr>
    <tr>
      <td style="text-align: center">4,4,3</td>
      <td style="text-align: center">4,3</td>
      <td style="text-align: center">3,3,4,3</td>
      <td style="text-align: center">4</td>
    </tr>
    <tr>
      <td style="text-align: center">2</td>
      <td style="text-align: center">2</td>
      <td style="text-align: center">3,3,4,3,2</td>
      <td style="text-align: center">6</td>
    </tr>
  </tbody>
</table>

<p><br /></p>

<p><strong>Questions</strong></p>
<ul>
  <li>What challenges would be faced if the total number of dice was much larger than 5, say 5000?</li>
  <li>What would be an interesting format for betting on Threes?  How could the information derived in this post be used to maximize earnings?</li>
  <li>How would Threes be solved if it involved more than two players?</li>
</ul>

<p><br /></p>

<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'andraugust-com'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>

<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>



      <footer class="site-footer">
        <!-- SVG icons from https://iconmonstr.com -->

        <!-- Github icon -->
        <span class="my-span-icon">
          <a href="" aria-label="'s GitHub" title="'s GitHub">
            <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
          </a>
        </span>

        <!-- Twitter icon -->
        <span class="my-span-icon">
          <a href="https://twitter.com/" aria-label="'s Twitter" title="'s Twitter">
            <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.066 9.645c.183 4.04-2.83 8.544-8.164 8.544-1.622 0-3.131-.476-4.402-1.291 1.524.18 3.045-.244 4.252-1.189-1.256-.023-2.317-.854-2.684-1.995.451.086.895.061 1.298-.049-1.381-.278-2.335-1.522-2.304-2.853.388.215.83.344 1.301.359-1.279-.855-1.641-2.544-.889-3.835 1.416 1.738 3.533 2.881 5.92 3.001-.419-1.796.944-3.527 2.799-3.527.825 0 1.572.349 2.096.907.654-.128 1.27-.368 1.824-.697-.215.671-.67 1.233-1.263 1.589.581-.07 1.135-.224 1.649-.453-.384.578-.87 1.084-1.433 1.489z"/></svg>
          </a>
        </span>

        <!-- RSS icon -->
        
        <!-- Contact icon -->
        
        
          <span class="my-span-icon">
            <a href="/about/" aria-label="Contact" title="Contact ">
              <svg class="my-svg-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M12 .02c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.99 6.98l-6.99 5.666-6.991-5.666h13.981zm.01 10h-14v-8.505l7 5.673 7-5.672v8.504z"/></svg>
            </a>
          </span>
        

      </footer>
    </section>

    
      <script type="text/javascript">
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-106854926-1', 'auto');
        ga('send', 'pageview');
      </script>
    
  </body>
</html>
